<!DOCTYPE html>
<html>

<head>
    <title>スポーツ大会エントリサイトを支えた技術</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="スポーツ大会エントリサイトを支えた技術, Web, sportsfes,web,application,server,security,develop, LinuxClub BLOG" />
    <meta name="description" content="スポーツ大会エントリサイトを支えた技術, Web, sportsfes,web,application,server,security,develop, はじめに" />
    <meta name="theme-color" content="#2CA6CB"/>
    <link rel="shortcut icon" type="image/x-icon" media="screen" href="http://0.0.0.0:4000/static/img/favicon.ico" />
    <link rel="canonical" href="http://0.0.0.0:4000/2018-06-20/sports-fes-entry-site/" />
    <link rel="alternate" type="application/rss+xml" title="LinuxClub BLOG" href="http://0.0.0.0:4000/feed.xml"  />

    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.bootcss.com/octicons/3.5.0/octicons.min.css" >
    <link rel="stylesheet" type="text/css" href="http://0.0.0.0:4000/static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="http://0.0.0.0:4000/static/css/highlight.css" />
    <link rel="stylesheet" type="text/css" href="http://0.0.0.0:4000/static/css/post.css" />
    

</head>


<body>

    <header>
        <nav class="navbar navbar-tiffany rectangle" role="navigation">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://0.0.0.0:4000/">LinuxClub BLOG</a>
                    <p class="navbar-text">東京工科大公認サークル LinuxClub のブログです.</p>
                </div>
                <div class="collapse navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        
                        <li>
                        <a href="http://0.0.0.0:4000/" class="word-keep"><span class="octicon octicon-book"></span></span>&nbsp;&nbsp;Blog</a>
                        </li>
                        
                        
                        <li>
                            <a href="http://0.0.0.0:4000/archive/" class="word-keep"><span class="octicon octicon-repo"></span>&nbsp;&nbsp;Archive</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="http://0.0.0.0:4000/category/" class="word-keep"><span class="octicon octicon-list-unordered"></span>&nbsp;&nbsp;Category</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="http://0.0.0.0:4000/tags/" class="word-keep"><span class="octicon octicon-tag"></span>&nbsp;&nbsp;Tag</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- li><a href="#stq=" class="search-button"><span class="octicon octicon-search"></span></a></li -->
                    </ul>
                </div>
            </div>
        </nav>
    </header>



<div class="main">
    <div class="container">
        <div class="row">
    <div class="content col-lg-9">
        <div class="sheet post">
          <header>
            <h2>スポーツ大会エントリサイトを支えた技術</h2>
            <p class="post-meta">
                <span class="octicon octicon-clock"></span> Jun 20, 2018
            </p>
            <p class="post-tag">
                <span><a href="http://0.0.0.0:4000/category/#Web"><span class="octicon octicon-list-unordered"></span>&nbsp;Web</a></span>
                <span>
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#sportsfes"><span class="octicon octicon-tag"></span>&nbsp;sportsfes</a>
                    
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#web"><span class="octicon octicon-tag"></span>&nbsp;web</a>
                    
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#application"><span class="octicon octicon-tag"></span>&nbsp;application</a>
                    
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#server"><span class="octicon octicon-tag"></span>&nbsp;server</a>
                    
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#security"><span class="octicon octicon-tag"></span>&nbsp;security</a>
                    
                    <a class="word-keep" href="http://0.0.0.0:4000/tags/#develop"><span class="octicon octicon-tag"></span>&nbsp;develop</a>
                    
                </span>
            </p>
          </header>
          <hr class="boundary">
          <article>
            <h2 id="はじめに">はじめに</h2>

<p>LinuxClubではスポーツ大会のエントリーサイトを運営しています。今年も体育会からの要請があり運営を行いました。この記事では運用に際し改善、改良を行った点を紹介します。</p>

<h2 id="dns">DNS</h2>

<p>従来は <code class="highlighter-rouge">www2.linux.it.teu.ac.jp/sports20xx/</code> の下に設置していました。今年度のサイトはサブドメイン  <code class="highlighter-rouge">sports.linux.it.teu.ac.jp</code> に設置しました。</p>

<h2 id="nginx">Nginx</h2>

<p>担当: panakuma</p>

<p>ページ読み込みの高速化によるユーザビリティとセキュリティの向上のためHTTP/2とTLSv1.3に対応させました。</p>

<h3 id="tlsv13対応">TLSv1.3対応</h3>

<p>TLSv1.3はまだドラフト段階の規格なので5月現在で最新であったdraft22/23に対応しました。</p>

<p>使用したプログラム</p>
<ul>
  <li>Nginx 1.13.10</li>
  <li>OpenSSL 1.1.1-pre3</li>
</ul>

<p>それぞれソースを公式サイトからダウンロードし、OpenSSLを組み込んでNginxをmakeしました。</p>

<h3 id="レスポンスヘッダcookie属性の変更">レスポンスヘッダ/Cookie属性の変更</h3>

<p>担当: koyama</p>

<p>セキュリティを高めるためにレスポンスヘッダへ以下を付与しました。</p>

<ul>
  <li>strict-transport-security: max-age=15768000; includeSubdomains</li>
  <li>x-frame-options: SAMEORIGIN</li>
  <li>x-xss-protection: 1; mode=block</li>
  <li>x-content-type-options: nosniff</li>
  <li>cache-control: private, no-store</li>
  <li>pragma: no-cache</li>
</ul>

<p><img src="/images/sportsfes2018/curl.png" width="500" /></p>

<p>それぞれのヘッダの役割は以下です。</p>

<ul>
  <li><code class="highlighter-rouge">strict-transport-security</code> はhttpsへ強制リダイレクトを実現しています。</li>
  <li><code class="highlighter-rouge">x-frame-options</code> はクリックジャッキング対策で付与しています。</li>
  <li><code class="highlighter-rouge">xss-protection</code> はブラウザのXSSフィルターを強制的にONに設定します。</li>
  <li><code class="highlighter-rouge">x-content-type-options</code> はContent-Typeの誤認識によるXSSを回避するために付与しています。</li>
  <li><code class="highlighter-rouge">cache-control</code> はプロキシサーバなどで機密情報が保存されないために付与しています。</li>
  <li><code class="highlighter-rouge">program</code> は古いブラウザでのキャッシュ保持を防ぎます。</li>
</ul>

<p>ブラウザのCookieに <code class="highlighter-rouge">secure</code> 属性と <code class="highlighter-rouge">httponly</code> 属性を付与しました。 <code class="highlighter-rouge">secure</code> 属性はクッキーをhttpsでやり取りするために付与します。 <code class="highlighter-rouge">httponly</code>　属性はJavaScriptからのCookieへのアクセスを禁止します。</p>

<p>セッションのタイムアウトを実装するためにCookieの <code class="highlighter-rouge">expires</code> 属性へセッション期限を設定しています。</p>

<p>これらはフレームワークの機能を使っています。そのため、セッションタイムの実装などを直接書かずに実現しています。</p>

<h2 id="ソースコードの修正サーバサイド">ソースコードの修正(サーバサイド)</h2>

<p>担当: koyama</p>

<p>既存のPythonコードを修正することで、チーム数制限を実装しました。従来はエントリー可能なチーム数の上限を設定していなかった為、上限なくエントリーできてしまいました。今年度のシステムはエントリー済みチーム数を取得することによって、エントリー上限に達するとエントリができなくなる仕組みを作りました。</p>

<p><img src="/images/sportsfes2018/basketball.png" width="500" /></p>

<h2 id="ソースコードの修正フロント">ソースコードの修正(フロント)</h2>

<p>担当: homirun</p>

<h3 id="デザインの変更">デザインの変更</h3>
<p>例年ページのテーマカラーが変わっていたため今年も気分で変えてみました。
また競技のルールを表示するページをアコーディオンボタンで開けるようにしました。</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">check</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">'.expander'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">check</span> <span class="o">===</span> <span class="mi">0</span><span class="p">){</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">'article'</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'aside'</span><span class="p">).</span><span class="nx">show</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'i'</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'fa-angle-down'</span><span class="p">)</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'i'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'fa-angle-up'</span><span class="p">)</span>
		<span class="nx">check</span> <span class="o">=</span> <span class="mi">1</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">closest</span><span class="p">(</span><span class="s1">'article'</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'aside'</span><span class="p">).</span><span class="nx">hide</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'i'</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">'fa-angle-up'</span><span class="p">)</span>
		<span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">children</span><span class="p">(</span><span class="s1">'i'</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">'fa-angle-down'</span><span class="p">)</span>
		<span class="nx">check</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>
<p>checkで現在のメニューの開閉状態を保持しています。
checkが0のときはarticleの子要素を表示させ、1のときは非表示にさせてます。</p>

<p>そのほか<code class="highlighter-rouge">Font Awesome</code>を用いボタンのアイコンなどわかりやすいものに変更しました。</p>

<p>　</p>
<h3 id="ui崩れ">UI崩れ</h3>
<p>モバイル端末でトップページを開いた際に画像がはみ出してしまう事があったのでCSSの該当箇所に<code class="highlighter-rouge">max-width: 100%</code>を追記し修正しました。</p>

<h2 id="脆弱性診断を実施">脆弱性診断を実施</h2>

<p>担当: koyama</p>

<p>オープンソースの脆弱性診断ツールである <code class="highlighter-rouge">OWASP ZAP</code> と <code class="highlighter-rouge">BurpSuite(Community Edition)</code>を使用しました。</p>

<p>まず、 <code class="highlighter-rouge">OWASP ZAP</code> のスキャン機能を使って既知な脆弱性を探しました。指摘された事項としては、レスポンスヘッダに <code class="highlighter-rouge">Progma</code> ヘッダが未付与であることだけでした。</p>

<p>次に、 <code class="highlighter-rouge">BurpSuite</code> （ローカルプロキシ）を使って手動で診断します。ブラウザを起動してプロキシの設定を <code class="highlighter-rouge">localhost:8080</code> に設定します。BurpSuiteのProxyタブ内からIntereptをOffにしておきます。診断は以下の手順で行います。</p>

<p>1.ブラウザを起動してWebサイトにアクセスします。</p>

<p>2.Proxyタブ内から<code class="highlighter-rouge">HTTP Proxy</code>を選ぶとリクエスト一覧が表示されます。</p>

<p><img src="/images/sportsfes2018/burp-httpHistory.png" width="500" /></p>

<p>3.リクエスト一覧から診断したいリクエストを見つけて、<code class="highlighter-rouge">右クリック -&gt; Send to Repeater</code> を実行します。</p>

<p>4.Repeaterタブを開いてリクエストを書き換えて <code class="highlighter-rouge">Go</code> をクリックします。右側にレスポンス結果が表示されるので、この結果から脆弱性の有無を判断します。</p>

<p><img src="/images/sportsfes2018/burp-repeater.png" width="500" /></p>

<p>以下は診断過程の一部です。クロスサイトスクリプティングの脆弱性がないか確認をしています。</p>

<p><img src="/images/sportsfes2018/xss-check.png" width="500" /></p>

<h2 id="運用">運用</h2>

<p>担当: koyama</p>

<p>問い合わせ先はGoogle Formを使用しました。また、Google Formが送信されるとSlackへ通知されるようプラグインを設定しました。</p>

<p><img src="/images/sportsfes2018/google-form.png" width="500" /></p>

<p>サイト監視用スクリプトを作成しました。スクリプトは実行されるとcurlコマンドを実行してステータスコードを確認します。ステータスコードが400未満であれば正常であると判断します。それ以外の場合は異常であると判断してSlackに通知を送信します。</p>

<pre><code class="language-shellscript">#!/bin/bash

URL="https://sports.linux.it.teu.ac.jp/"
DEBUG=1
DATE=$(date "+%Y/%m/%d %H:%M:%S")

# Send Req
RESPONSE_CODE=$(curl -LI $URL -o /dev/null -w '%{http_code}\n' -s)

# Handle ReqCode
if [ $RESPONSE_CODE -lt 500 ] ; then # RESPONSE_CODE &lt; 500

  # SUCCESS
  test $DEBUG -gt 0 &amp;&amp; echo "[DEBUG] Successful access"

else
  
  # FAIL
  test $DEBUG -gt 0 &amp;&amp; echo "[DEBUG] Fail to access"

  ### Post to Slack
  TOKEN=''
  USER='SiteChecker'
  CHANNEL='sportsfes'
  MESSAGE="[Error:$RESPONSE_CODE] Fail to access $URL at $DATE"

  curl -s -XPOST -d "token=$TOKEN" \
                 -d "channel=#$CHANNEL" \
                 -d "text=$MESSAGE" \
                 -d "username=$USER" \
                 "https://slack.com/api/chat.postMessage" # &gt;&amp; /dev/null &amp;

fi
</code></pre>

<p><img src="/images/sportsfes2018/site-checker.png" width="500" /></p>

<p>Nginxのログ解析用のスクリプトをPythonで作成しました。</p>

<script src="https://gist.github.com/tomoyk/b7502d2f2a19e21291d8ad60eb2892b6.js"></script>

<p><img src="/images/sportsfes2018/chart.png" width="500" /></p>

          </article>
          <hr class="boundary">
          <div id="post-share" class="bdsharebuttonbox">
              <!-- a href="#" class="bds_more" data-cmd="more"></a>
              <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
              <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
              <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
              <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
              <a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a -->
              <a href="https://twitter.com/share" class="twitter-share-button" data-via="lc_tut" data-size="large">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
              <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="28" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
              <div style="display: inline-block; transform: scale(1.5);padding-left: 10px;">
                <a data-pocket-label="pocket" data-pocket-count="none" class="pocket-btn" data-lang="en"></a>
                <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>
              </div>
          </div>
          <!-- div class="pad-min"></div>
          <div id="post-comment" class="sheet post">
              <div id="disqus_thread"></div>
          </div -->
        </div>
    </div>
    <div class="content-navigation col-lg-3">
      <div class="shadow-bottom-center" >
        <div class="content-navigation-toc">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Toc
            </div>
            <div class="content-navigation-list toc"></div>
        </div>
        <div class="content-navigation-tag">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Tags
            </div>
            <div class="content-navigation-list">
                <ul>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#sportsfes"><span class="octicon octicon-tag"></span>&nbsp;sportsfes</a>
                    </li>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#web"><span class="octicon octicon-tag"></span>&nbsp;web</a>
                    </li>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#application"><span class="octicon octicon-tag"></span>&nbsp;application</a>
                    </li>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#server"><span class="octicon octicon-tag"></span>&nbsp;server</a>
                    </li>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#security"><span class="octicon octicon-tag"></span>&nbsp;security</a>
                    </li>
                    
                    <li>
                        <a href="http://0.0.0.0:4000/tags#develop"><span class="octicon octicon-tag"></span>&nbsp;develop</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="content-navigation-related">
            <div class="content-navigation-header">
                <span class="octicon octicon-list-unordered"></span>&nbsp;Related
            </div>
            <div class="content-navigation-list">
                <ul>
                    

                    

                    
                </ul>
            </div>
        </div>
      </div>
    </div>
</div>

    </div>
    <div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
        <a href="javascript:void(0);">
            <div class="arrow"></div>
            <div class="stick"></div>
        </a>
    </div>
</div>

    <footer  class="footnote footnote-tiffany">
        <div class="container">
                <a class="foot-item" href="mailto:linuxclub.tut@gmail.com" target="_blank"><span class="octicon octicon-mail"></span></a>
                <a class="foot-item" href="https://github.com/lc-tut" target="_blank"><span class="octicon octicon-mark-github"></span></a>
                <a class="foot-item" href="http://0.0.0.0:4000/feed.xml" target="_blank"><span class="octicon octicon-rss"></span></a>
                <a class="foot-item" href="http://0.0.0.0:4000/link/"><span class="octicon octicon-link-external"></span></a>
                &nbsp;
                <a href="http://blog.rainyalley.com/"><span class="word-keep">&copy; RainyAlley</span></a>
        </div>
    </footer>
    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://0.0.0.0:4000/static/js/script.js"></script>
    <script type="text/javascript" src="http://0.0.0.0:4000/static/js/post.js"></script>
    


</body>
</html>
