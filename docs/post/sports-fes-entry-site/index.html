<!DOCTYPE html>
<html class="no-js">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>スポーツ大会エントリサイトを支えた技術 2018</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="LinuxClubでは2018年度スポーツ大会エントリーサイトの運営を行いました。この記事では使用した技術やシステム運用の詳細を紹介します。" />

<meta name="keywords" content="web, application, Python, Server, Security, Nginx, TLS, ">


<meta property="og:title" content="スポーツ大会エントリサイトを支えた技術 2018  &middot; LinuxClub BLOG ">
<meta property="og:site_name" content="LinuxClub BLOG"/>
<meta property="og:url" content="https://lc-tut.github.io/post/sports-fes-entry-site/" />
<meta property="og:locale" content="ja-jp">


<meta property="og:type" content="article" />
<meta property="og:description" content="LinuxClubでは2018年度スポーツ大会エントリーサイトの運営を行いました。この記事では使用した技術やシステム運用の詳細を紹介します。"/>
<meta property="og:article:published_time" content="2018-06-20T00:00:00Z" />
<meta property="og:article:modified_time" content="2018-06-20T00:00:00Z" />

  
    
<meta property="og:article:tag" content="web">
    
<meta property="og:article:tag" content="application">
    
<meta property="og:article:tag" content="Python">
    
<meta property="og:article:tag" content="Server">
    
<meta property="og:article:tag" content="Security">
    
<meta property="og:article:tag" content="Nginx">
    
<meta property="og:article:tag" content="TLS">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="スポーツ大会エントリサイトを支えた技術 2018" />
<meta name="twitter:description" content="LinuxClubでは2018年度スポーツ大会エントリーサイトの運営を行いました。この記事では使用した技術やシステム運用の詳細を紹介します。" />
<meta name="twitter:url" content="https://lc-tut.github.io/post/sports-fes-entry-site/" />
<meta name="twitter:domain" content="https://lc-tut.github.io/">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "スポーツ大会エントリサイトを支えた技術 2018",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2018-06-20",
    "description": "LinuxClubでは2018年度スポーツ大会エントリーサイトの運営を行いました。この記事では使用した技術やシステム運用の詳細を紹介します。",
    "wordCount": 241
  }
</script>


<link rel="canonical" href="https://lc-tut.github.io/post/sports-fes-entry-site/" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/tomorrow-night.css">

  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon-precomposed" sizes="60x60" href="/apple-touch-icon-60x60.png" />
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon-precomposed" sizes="76x76" href="/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" href="/favicon-196x196.png" sizes="196x196" />
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16" />
<link rel="icon" type="image/png" href="/favicon-128.png" sizes="128x128" />
<meta name="application-name" content="スポーツ大会エントリサイトを支えた技術 2018"/>
<meta name="msapplication-TileColor" content="#FFFFFF" />
<meta name="msapplication-TileImage" content="/mstile-144x144.png" />
<meta name="msapplication-square70x70logo" content="/mstile-70x70.png" />
<meta name="msapplication-square150x150logo" content="/mstile-150x150.png" />
<meta name="msapplication-wide310x150logo" content="/mstile-310x150.png" />
<meta name="msapplication-square310x310logo" content="/mstile-310x310.png" />

</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-md site-navbar bg-info">
    <a class="navbar-brand text-white" href="https://lc-tut.github.io/">LinuxClub BLOG</a>
  <button class="navbar-toggler" 
  type="button" data-toggle="collapse" data-target="#exCollapsingNavbar2" aria-controls="exCollapsingNavbar2"
    aria-expanded="false" aria-label="Toggle navigation">
    &#9776;
  </button>
  <div class="collapse navbar-collapse" id="exCollapsingNavbar2">
    <ul class="nav navbar-nav ml-auto">
       
    </ul>
  </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col-sm-12">
    
      <div>
  <h1 class="post-title">スポーツ大会エントリサイトを支えた技術 2018
</h1>

  <div class="post-meta">
  <div class="post-meta-item">
    <time datetime="06 Jun 20066">20 Jun, 2018</time>
    &middot; 2 min read
    &middot; 241 Words
  </div>

  
      
      
      <div class="post-meta-item">
          <i class="fa fa-folder-open-o"></i>
          
          <a class="article-category-link" href="/categories/infra/">Infra</a>
          
          
      </div>
      
  

  
      
      
        <div class="post-meta-item">
          <i class="fa fa-tags"></i>
          
          <a href="/tags/web/">web</a>
          &middot;
          
          <a href="/tags/application/">application</a>
          &middot;
          
          <a href="/tags/python/">Python</a>
          &middot;
          
          <a href="/tags/server/">Server</a>
          &middot;
          
          <a href="/tags/security/">Security</a>
          &middot;
          
          <a href="/tags/nginx/">Nginx</a>
          &middot;
          
          <a href="/tags/tls/">TLS</a>
          
          
        </div>
      
  

</div>

  

</div>

      <div class="article-body">
  

<h2 id="はじめに">はじめに</h2>

<p>LinuxClubではスポーツ大会のエントリーサイトを運営しています。今年も体育会からの要請があり運営を行いました。この記事では運用に際し改善、改良を行った点を紹介します。</p>

<h2 id="dns">DNS</h2>

<p>従来は <code>www2.linux.it.teu.ac.jp/sports20xx/</code> の下に設置していました。今年度のサイトはサブドメイン  <code>sports.linux.it.teu.ac.jp</code> に設置しました。</p>

<h2 id="nginx">Nginx</h2>

<p>担当: panakuma</p>

<p>ページ読み込みの高速化によるユーザビリティとセキュリティの向上のためHTTP/2とTLSv1.3に対応させました。</p>

<h3 id="tlsv1-3対応">TLSv1.3対応</h3>

<p>TLSv1.3はまだドラフト段階の規格なので5月現在で最新であったdraft22/23に対応しました。</p>

<p>使用したプログラム
- Nginx 1.13.10
- OpenSSL 1.1.1-pre3</p>

<p>それぞれソースを公式サイトからダウンロードし、OpenSSLを組み込んでNginxをmakeしました。</p>

<h3 id="レスポンスヘッダ-cookie属性の変更">レスポンスヘッダ/Cookie属性の変更</h3>

<p>担当: koyama</p>

<p>セキュリティを高めるためにレスポンスヘッダへ以下を付与しました。</p>

<ul>
<li>strict-transport-security: max-age=15768000; includeSubdomains</li>
<li>x-frame-options: SAMEORIGIN</li>
<li>x-xss-protection: 1; mode=block</li>
<li>x-content-type-options: nosniff</li>
<li>cache-control: private, no-store</li>
<li>pragma: no-cache</li>
</ul>

<p><img src="/post_media/sportsfes2018/curl.png" width="500"></p>

<p>それぞれのヘッダの役割は以下です。</p>

<ul>
<li><code>strict-transport-security</code> はhttpsへ強制リダイレクトを実現しています。</li>
<li><code>x-frame-options</code> はクリックジャッキング対策で付与しています。</li>
<li><code>xss-protection</code> はブラウザのXSSフィルターを強制的にONに設定します。</li>
<li><code>x-content-type-options</code> はContent-Typeの誤認識によるXSSを回避するために付与しています。</li>
<li><code>cache-control</code> はプロキシサーバなどで機密情報が保存されないために付与しています。</li>
<li><code>program</code> は古いブラウザでのキャッシュ保持を防ぎます。</li>
</ul>

<p>ブラウザのCookieに <code>secure</code> 属性と <code>httponly</code> 属性を付与しました。 <code>secure</code> 属性はクッキーをhttpsでやり取りするために付与します。 <code>httponly</code>　属性はJavaScriptからのCookieへのアクセスを禁止します。</p>

<p>セッションのタイムアウトを実装するためにCookieの <code>expires</code> 属性へセッション期限を設定しています。</p>

<p>これらはフレームワークの機能を使っています。そのため、セッションタイムの実装などを直接書かずに実現しています。</p>

<h2 id="ソースコードの修正-サーバサイド">ソースコードの修正(サーバサイド)</h2>

<p>担当: koyama</p>

<p>既存のPythonコードを修正することで、チーム数制限を実装しました。従来はエントリー可能なチーム数の上限を設定していなかった為、上限なくエントリーできてしまいました。今年度のシステムはエントリー済みチーム数を取得することによって、エントリー上限に達するとエントリができなくなる仕組みを作りました。</p>

<p><img src="/post_media/sportsfes2018/basketball.png" width="500"></p>

<h2 id="ソースコードの修正-フロント">ソースコードの修正(フロント)</h2>

<p>担当: homirun</p>

<h3 id="デザインの変更">デザインの変更</h3>

<p>例年ページのテーマカラーが変わっていたため今年も気分で変えてみました。
また競技のルールを表示するページをアコーディオンボタンで開けるようにしました。</p>

<pre><code class="language-javascript">let check = 0
$('.expander').click(function() {
	if (check === 0){
		$(this).closest('article').children('aside').show(300);
		$(this).children('i').removeClass('fa-angle-down')
		$(this).children('i').addClass('fa-angle-up')
		check = 1
	}else{
		$(this).closest('article').children('aside').hide(300);
		$(this).children('i').removeClass('fa-angle-up')
		$(this).children('i').addClass('fa-angle-down')
		check = 0
	}
});
</code></pre>

<p>checkで現在のメニューの開閉状態を保持しています。
checkが0のときはarticleの子要素を表示させ、1のときは非表示にさせてます。</p>

<p>そのほか<code>Font Awesome</code>を用いボタンのアイコンなどわかりやすいものに変更しました。</p>

<p>　</p>

<h3 id="ui崩れ">UI崩れ</h3>

<p>モバイル端末でトップページを開いた際に画像がはみ出してしまう事があったのでCSSの該当箇所に<code>max-width: 100%</code>を追記し修正しました。</p>

<h2 id="脆弱性診断を実施">脆弱性診断を実施</h2>

<p>担当: koyama</p>

<p>オープンソースの脆弱性診断ツールである <code>OWASP ZAP</code> と <code>BurpSuite(Community Edition)</code>を使用しました。</p>

<p>まず、 <code>OWASP ZAP</code> のスキャン機能を使って既知な脆弱性を探しました。指摘された事項としては、レスポンスヘッダに <code>Progma</code> ヘッダが未付与であることだけでした。</p>

<p>次に、 <code>BurpSuite</code> （ローカルプロキシ）を使って手動で診断します。ブラウザを起動してプロキシの設定を <code>localhost:8080</code> に設定します。BurpSuiteのProxyタブ内からIntereptをOffにしておきます。診断は以下の手順で行います。</p>

<p>1.ブラウザを起動してWebサイトにアクセスします。</p>

<p>2.Proxyタブ内から<code>HTTP Proxy</code>を選ぶとリクエスト一覧が表示されます。</p>

<p><img src="/post_media/sportsfes2018/burp-httpHistory.png" width="500"></p>

<p>3.リクエスト一覧から診断したいリクエストを見つけて、<code>右クリック -&gt; Send to Repeater</code> を実行します。</p>

<p>4.Repeaterタブを開いてリクエストを書き換えて <code>Go</code> をクリックします。右側にレスポンス結果が表示されるので、この結果から脆弱性の有無を判断します。</p>

<p><img src="/post_media/sportsfes2018/burp-repeater.png" width="500"></p>

<p>以下は診断過程の一部です。クロスサイトスクリプティングの脆弱性がないか確認をしています。</p>

<p><img src="/post_media/sportsfes2018/xss-check.png" width="500"></p>

<h2 id="運用">運用</h2>

<p>担当: koyama</p>

<p>問い合わせ先はGoogle Formを使用しました。また、Google Formが送信されるとSlackへ通知されるようプラグインを設定しました。</p>

<p><img src="/post_media/sportsfes2018/google-form.png" width="500"></p>

<p>サイト監視用スクリプトを作成しました。スクリプトは実行されるとcurlコマンドを実行してステータスコードを確認します。ステータスコードが400未満であれば正常であると判断します。それ以外の場合は異常であると判断してSlackに通知を送信します。</p>

<pre><code class="language-shellscript">#!/bin/bash

URL=&quot;https://sports.linux.it.teu.ac.jp/&quot;
DEBUG=1
DATE=$(date &quot;+%Y/%m/%d %H:%M:%S&quot;)

# Send Req
RESPONSE_CODE=$(curl -LI $URL -o /dev/null -w '%{http_code}\n' -s)

# Handle ReqCode
if [ $RESPONSE_CODE -lt 500 ] ; then # RESPONSE_CODE &lt; 500

  # SUCCESS
  test $DEBUG -gt 0 &amp;&amp; echo &quot;[DEBUG] Successful access&quot;

else
  
  # FAIL
  test $DEBUG -gt 0 &amp;&amp; echo &quot;[DEBUG] Fail to access&quot;

  ### Post to Slack
  TOKEN=''
  USER='SiteChecker'
  CHANNEL='sportsfes'
  MESSAGE=&quot;[Error:$RESPONSE_CODE] Fail to access $URL at $DATE&quot;

  curl -s -XPOST -d &quot;token=$TOKEN&quot; \
                 -d &quot;channel=#$CHANNEL&quot; \
                 -d &quot;text=$MESSAGE&quot; \
                 -d &quot;username=$USER&quot; \
                 &quot;https://slack.com/api/chat.postMessage&quot; # &gt;&amp; /dev/null &amp;

fi
</code></pre>

<p><img src="/post_media/sportsfes2018/site-checker.png" width="500"></p>

<p>Nginxのログ解析用のスクリプトをPythonで作成しました。</p>

<script src="https://gist.github.com/tomoyk/b7502d2f2a19e21291d8ad60eb2892b6.js"></script>

<p><img src="/post_media/sportsfes2018/chart.png" width="500"></p>

</div>

      </div>
  </div>
  <div class="row">  
   
  
          
           
      <div class="col-sm-12 col-sm-12 col-md-12 col-lg-12">
        <div class="pt-4" id="comment-section">
          
        </div>
      </div>
   
  </div>
  
</div>
      <footer class="footer text-white bg-info">
  <div class="container">
    <div class="row">
      <div class="offset-lg-1 col-lg-10 col-xs-12">
        <p class="text-center mb-0 pa-0">
          &copy; 2019 
        </p>
        
      </div>
    </div>
  </div>
</footer>

    
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


<script src="/assets/js/script.js"></script>




  </body>
</html>

